generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String     @id @default(uuid())
  firstName        String
  middleName       String? // optional 
  lastName         String? // optional
  email            String     @unique
  passwordHash     String?
  role             Role
  profilePicUrl    String?
  homeLocation     Json?
  workLocation     Json?
  schedule         Json?
  rating           Float?     @default(0)
  createdAt        DateTime   @default(now())
  bookings         Booking[]  @relation("RiderBookings")
  feedbackReceived Feedback[] @relation("FeedbackReceived")
  feedbackGiven    Feedback[] @relation("FeedbackGiven")
  driverProfile    Driver?
}

model Driver {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  licenseNumber String?
  verified      Boolean  @default(false)
  joinedAt      DateTime @default(now())

  rides     Ride[]
  vehicles  Vehicle[]
  documents DriverDocument[]
}

model Vehicle {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id])

  make        String
  model       String
  year        Int
  plateNumber String   @unique
  color       String?
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model DriverDocument {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id])

  type       DocumentType
  fileUrl    String
  verified   Boolean      @default(false)
  uploadedAt DateTime     @default(now())
}

enum DocumentType {
  licence
  national_id
  passport
  police_clearance
}

model Ride {
  id             String     @id @default(uuid())
  driverId       String
  driver         Driver     @relation(fields: [driverId], references: [id])
  startLocation  Json
  endLocation    Json
  departureTime  DateTime
  availableSeats Int
  costPerRider   Float
  status         RideStatus @default(open)
  createdAt      DateTime   @default(now())
  bookings       Booking[]
  feedback       Feedback[]
}

model Booking {
  id            String        @id @default(uuid())
  rideId        String
  riderId       String
  status        BookingStatus @default(pending)
  paymentStatus PaymentStatus @default(unpaid)
  createdAt     DateTime      @default(now())
  ride          Ride          @relation(fields: [rideId], references: [id])
  rider         User          @relation("RiderBookings", fields: [riderId], references: [id])
  payment       Payment?
}

model Payment {
  id             String        @id @default(uuid())
  bookingId      String        @unique
  amount         Float
  method         PaymentMethod
  status         PaymentStatus @default(pending)
  transactionRef String?
  createdAt      DateTime      @default(now())
  booking        Booking       @relation(fields: [bookingId], references: [id])
}

model Feedback {
  id        String   @id @default(uuid())
  rideId    String
  raterId   String
  rateeId   String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  ratee     User     @relation("FeedbackReceived", fields: [rateeId], references: [id])
  rater     User     @relation("FeedbackGiven", fields: [raterId], references: [id])
  ride      Ride     @relation(fields: [rideId], references: [id])
}

model Company {
  id          String     @id @default(uuid())
  companyName String
  domainName  String     @unique
  createdAt   DateTime   @default(now())
  routes      Route[]
  locations   Location[]
}

model Admin {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  role         AdminRole
  passwordHash String
  routes       Route[]
}

enum LocationType {
  office
  custom
}

model Location {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name      String
  latitude  Float
  longitude Float
  type      LocationType @default(custom)

  createdAt DateTime @default(now())

  startRoutes Route[]     @relation("StartLocation")
  endRoutes   Route[]     @relation("EndLocation")
  routeStops  RouteStop[]
}

model Route {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  adminId String
  admin   Admin  @relation(fields: [adminId], references: [id])

  startLocationId String
  startLocation   Location @relation("StartLocation", fields: [startLocationId], references: [id])

  endLocationId String
  endLocation   Location @relation("EndLocation", fields: [endLocationId], references: [id])

  distance  Float
  createdAt DateTime @default(now())

  stops RouteStop[]
}

model RouteStop {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  order Int

  @@unique([routeId, order])
}

enum Role {
  driver
  rider
  both
  admin
}

enum RideStatus {
  open
  booked
  completed
  cancelled
}

enum BookingStatus {
  pending
  confirmed
  cancelled
}

enum PaymentStatus {
  unpaid
  paid
  refunded
  pending
  completed
  failed
}

enum PaymentMethod {
  stripe
  mpesa
  paypal
}

enum AdminRole {
  admin
  superadmin
}
