generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String     @id @default(uuid())
  name             String
  email            String     @unique
  passwordHash     String?
  role             Role
  homeLocation     Json?
  workLocation     Json?
  schedule         Json?
  rating           Float?     @default(0)
  createdAt        DateTime   @default(now())
  bookings         Booking[]  @relation("RiderBookings")
  feedbackReceived Feedback[] @relation("FeedbackReceived")
  feedbackGiven    Feedback[] @relation("FeedbackGiven")
  rides            Ride[]     @relation("DriverRides")
}

model Ride {
  id             String     @id @default(uuid())
  driverId       String
  startLocation  Json
  endLocation    Json
  departureTime  DateTime
  availableSeats Int
  costPerRider   Float
  status         RideStatus @default(open)
  createdAt      DateTime   @default(now())
  bookings       Booking[]
  feedback       Feedback[]
  driver         User       @relation("DriverRides", fields: [driverId], references: [id])
}

model Booking {
  id            String        @id @default(uuid())
  rideId        String
  riderId       String
  status        BookingStatus @default(pending)
  paymentStatus PaymentStatus @default(unpaid)
  createdAt     DateTime      @default(now())
  ride          Ride          @relation(fields: [rideId], references: [id])
  rider         User          @relation("RiderBookings", fields: [riderId], references: [id])
  payment       Payment?
}

model Payment {
  id             String        @id @default(uuid())
  bookingId      String        @unique
  amount         Float
  method         PaymentMethod
  status         PaymentStatus @default(pending)
  transactionRef String?
  createdAt      DateTime      @default(now())
  booking        Booking       @relation(fields: [bookingId], references: [id])
}

model Feedback {
  id        String   @id @default(uuid())
  rideId    String
  raterId   String
  rateeId   String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  ratee     User     @relation("FeedbackReceived", fields: [rateeId], references: [id])
  rater     User     @relation("FeedbackGiven", fields: [raterId], references: [id])
  ride      Ride     @relation(fields: [rideId], references: [id])
}

// prisma/schema.prisma

model Company {
  id          String     @id @default(uuid())
  companyName String
  domainName  String     @unique
  createdAt   DateTime   @default(now())
  routes      Route[]
  locations   Location[]
}

model Admin {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  role         AdminRole
  passwordHash String // <-- add this
  routes       Route[]
}

model Location {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name      String // formatted address from Google
  latitude  Float
  longitude Float

  createdAt DateTime @default(now())

  // reverse relations
  startRoutes Route[]     @relation("StartLocation")
  endRoutes   Route[]     @relation("EndLocation")
  routeStops  RouteStop[]
}

model Route {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  adminId String
  admin   Admin  @relation(fields: [adminId], references: [id])

  startLocationId String
  startLocation   Location @relation("StartLocation", fields: [startLocationId], references: [id])

  endLocationId String
  endLocation   Location @relation("EndLocation", fields: [endLocationId], references: [id])

  distance  Float
  createdAt DateTime @default(now())

  // ordered via stops
  stops RouteStop[]
}

model RouteStop {
  id      String @id @default(uuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  order Int // 0,1,2... to keep via order

  @@unique([routeId, order]) // one stop per position
}

enum Role {
  driver
  rider
  both
  admin
}

enum RideStatus {
  open
  booked
  completed
  cancelled
}

enum BookingStatus {
  pending
  confirmed
  cancelled
}

enum PaymentStatus {
  unpaid
  paid
  refunded
  pending
  completed
  failed
}

enum PaymentMethod {
  stripe
  mpesa
  paypal
}

enum AdminRole {
  admin
  superadmin
}
